# Домашнее задание к занятию "Резервное копирование баз данных" - Политико Ксения


Задание 1. Резервное копирование
Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.
Необходимо описать, какие варианты резервного копирования подходят в случаях:
1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.
1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.
1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.
Приведите ответ в свободной форме.
Для повышения надежности работы базы данных (БД) и резервного копирования можно рассмотреть различные стратегии в зависимости от требований к восстановлению данных. Рассмотрим каждый из предложенных кейсов:

1.1 Восстановление данных в полном объеме за предыдущий день
Для этого подойдет полное резервное копирование (Full Backup), выполняемое ежедневно. Полное резервное копирование создает копию всех данных в БД на момент выполнения бэкапа. Это позволяет восстановить данные в том состоянии, в котором они были на момент последнего бэкапа.
Преимущества:
Простота восстановления: нужно только развернуть последний полный бэкап.
Надежность: все данные хранятся в одном месте.
Недостатки:
Требует больше времени и ресурсов для создания бэкапа.
Занимает больше места на хранилище.
Рекомендации:
Выполнять полное резервное копирование каждую ночь, когда нагрузка на БД минимальна.
Хранить несколько последних полных бэкапов для дополнительной надежности.

1.2 Восстановление данных за час до предполагаемой поломки
Для этого потребуется комбинация полного резервного копирования и инкрементного/дифференциального бэкапа.
Инкрементное резервное копирование (Incremental Backup): сохраняет только изменения, произошедшие с момента последнего бэкапа (полного или инкрементного).
Дифференциальное резервное копирование (Differential Backup): сохраняет все изменения, произошедшие с момента последнего полного бэкапа.
Преимущества:
Быстрое создание бэкапов (инкрементные бэкапы занимают меньше места и времени).
Возможность восстановить данные на конкретный момент времени.
Недостатки:
Восстановление требует больше времени, так как нужно применить полный бэкап и все последующие инкрементные/дифференциальные бэкапы.
Сложность управления цепочкой бэкапов.
Рекомендации:
Выполнять полное резервное копирование раз в день.
Делать инкрементные или дифференциальные бэкапы каждый час.
Использовать инструменты для автоматизации процесса (например, cron-задания или встроенные функции СУБД).

1.3 Моментальное переключение на работающую/починеную БД при поломке*
Это возможно с использованием репликации БД и отказоустойчивых кластеров.
Репликация (Replication): создание одной или нескольких копий БД (реплик), которые синхронизируются с основной БД в реальном времени.
Синхронная репликация: данные записываются на основную БД и реплику одновременно. Гарантирует отсутствие потери данных, но может замедлять работу.
Асинхронная репликация: данные сначала записываются на основную БД, а затем синхронизируются с репликой. Быстрее, но возможна небольшая задержка в данных.
Отказоустойчивые кластеры (Failover Clusters): автоматическое переключение на резервную БД в случае сбоя основной. Например, использование решений вроде PostgreSQL с Patroni, MySQL с GTID, MongoDB с Replica Set или SQL Server AlwaysOn.
Преимущества:
Минимальное время простоя (вплоть до нескольких секунд).
Высокая доступность системы.
Недостатки:
Требует дополнительных ресурсов (серверы для реплик).
Сложность настройки и поддержки.
Рекомендации:
Использовать синхронную репликацию для критически важных данных.
Настроить автоматическое переключение (failover) с помощью кластерных решений.
Регулярно тестировать отказоустойчивость системы.

Дополнительные     рекомендации
Шифрование бэкапов: чтобы защитить данные от несанкционированного доступа.
Хранение бэкапов в разных локациях: например, локально и в облаке (S3, Google Cloud Storage и т.д.).
Регулярное тестирование восстановления: чтобы убедиться, что бэкапы работают корректно.
Мониторинг и алертинг: для оперативного реагирования на сбои в работе БД или процессах резервного копирования.
Таким образом, выбор стратегии зависит от требований к времени восстановления, доступности данных и ресурсов компании.

Задание 2. PostgreSQL
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).
Для резервного копирования и восстановления данных в PostgreSQL часто используются утилиты pg_dump и pg_restore. Эти инструменты позволяют создавать бэкапы и восстанавливать данные из них. Ниже приведены примеры команд для резервирования и восстановления БД с использованием официальной документации PostgreSQL.

1. Резервное копирование с помощью pg_dump
Команда pg_dump создает дамп базы данных в виде файла. Этот файл можно использовать для восстановления данных.
Пример команды для создания дампа:
bash
pg_dump -U username -F c -b -v -f backup_file.dump dbname
Опции:
-U username: Указывает пользователя PostgreSQL.
-F c: Формат вывода (в данном случае, custom-формат, который поддерживает сжатие и гибкость при восстановлении).
-b: Включает резервное копирование больших объектов (BLOBs).
-v: Включает подробный вывод (verbose).
-f backup_file.dump: Указывает имя файла для сохранения дампа.
dbname: Имя базы данных, которую нужно备份.
Пример для резервирования базы mydatabase:
bash
pg_dump -U myuser -F c -b -v -f mydatabase_backup.dump mydatabase

2. Восстановление данных с помощью pg_restore
Команда pg_restore используется для восстановления данных из дампа, созданного с помощью pg_dump.
Пример команды для восстановления:
bash
pg_restore -U username -d dbname -v backup_file.dump
Опции:
-U username: Указывает пользователя PostgreSQL.
-d dbname: Указывает имя базы данных, в которую нужно восстановить данные.
-v: Включает подробный вывод (verbose).
backup_file.dump: Имя файла дампа.
Пример для восстановления базы mydatabase:
bash
pg_restore -U myuser -d mydatabase -v mydatabase_backup.dump

3. Дополнительные примеры
Резервирование в текстовом формате (SQL-файл):
bash
pg_dump -U myuser -F p -f mydatabase_backup.sql mydatabase
-F p: Указывает текстовый формат (SQL-файл).
Восстановление из текстового формата:
bash
psql -U myuser -d mydatabase -f mydatabase_backup.sql
psql: Утилита для выполнения SQL-команд.
-f: Указывает файл для выполнения.

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?
Автоматизация резервного копирования PostgreSQL возможна с использованием:
cron (Linux/Unix),
Task Scheduler (Windows),
специализированных инструментов (pgAdmin, Barman),
облачных решений.
Это обеспечит регулярное создание бэкапов и снизит риски потери данных.

Задание 3. MySQL
3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.
В MySQL инкрементное резервное копирование обычно выполняется с использованием бинарных логов (binary logs). Бинарные логи содержат все изменения, внесенные в базу данных (INSERT, UPDATE, DELETE и т.д.), и могут быть использованы для восстановления данных на определенный момент времени или для инкрементного резервного копирования.

1. Включение бинарных логов
Для использования инкрементного резервного копирования необходимо убедиться, что бинарные логи включены. Это можно проверить в конфигурационном файле MySQL (my.cnf или my.ini):
ini
[mysqld]
log_bin = /var/log/mysql/mysql-bin.log
expire_logs_days = 7
log_bin: Указывает путь и префикс для файлов бинарных логов.
expire_logs_days: Автоматическое удаление старых бинарных логов через указанное количество дней.
После изменения конфигурации перезапустите MySQL:
bash
sudo systemctl restart mysql

2. Полное резервное копирование
Перед началом инкрементного резервного копирования необходимо создать полную резервную копию базы данных. Это можно сделать с помощью утилиты mysqldump:
bash
mysqldump -u username -p --all-databases --single-transaction --flush-logs --master-data=2 > full_backup.sql
Опции:
--all-databases: Резервирует все базы данных.
--single-transaction: Использует транзакцию для обеспечения согласованности данных.
--flush-logs: Закрывает текущий бинарный лог и начинает новый.
--master-data=2: Записывает позицию бинарного лога в резервную копию (полезно для восстановления).

3. Инкрементное резервное копирование
Инкрементное резервное копирование выполняется путем копирования бинарных логов, созданных после последнего полного бэкапа.
Шаги:
Определите текущий бинарный лог:
Выполните команду в MySQL:
sql
SHOW MASTER STATUS;
Результат будет содержать имя текущего бинарного лога и позицию (например, mysql-bin.000002).
Скопируйте бинарные логи:
Скопируйте файлы бинарных логов, созданные после последнего полного бэкапа. Например:
bash
cp /var/log/mysql/mysql-bin.000002 /backup/incremental_backup/
Периодическое выполнение:
Повторяйте этот процесс через заданные интервалы времени (например, каждый час).

4. Восстановление из инкрементного бэкапа
Для восстановления данных:
Восстановите полный бэкап:
bash
mysql -u username -p < full_backup.sql
Примените инкрементные изменения из бинарных логов:
Используйте утилиту mysqlbinlog для применения изменений:
bash
mysqlbinlog /backup/incremental_backup/mysql-bin.000002 | mysql -u username -p

5. Автоматизация инкрементного резервного копирования
Для автоматизации можно использовать скрипты и планировщик задач (например, cron).
Пример скрипта для инкрементного резервного копирования:
bash
#!/bin/bash

# Параметры
USER="username"
PASSWORD="password"
BACKUP_DIR="/backup/incremental_backup"
LOG_FILE="/var/log/mysql/backup.log"

# Определение текущего бинарного лога
CURRENT_LOG=$(mysql -u $USER -p$PASSWORD -e "SHOW MASTER STATUS" | awk 'NR==2 {print $1}')

# Копирование бинарного лога
cp /var/log/mysql/$CURRENT_LOG $BACKUP_DIR/

# Логирование
echo "$(date): Incremental backup completed for $CURRENT_LOG" >> $LOG_FILE
Настройка cron для выполнения скрипта каждый час:
bash
0 * * * * /path/to/incremental_backup.sh

Итог
Инкрементное резервное копирование в MySQL выполняется с использованием бинарных логов. Основные шаги:
● Включить бинарные логи.
● Создать полный бэкап с помощью mysqldump.
● Периодически копировать бинарные логи для инкрементного резервного копирования.
● Восстанавливать данные, применяя полный бэкап и инкрементные изменения.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?
Использование реплики базы данных дает значительные преимущества по сравнению с обычным резервным копированием в следующих случаях:

1. Минимальное время простоя (High Availability)
Реплика позволяет мгновенно переключиться на резервную копию базы данных в случае сбоя основной БД. Это особенно важно для систем, где критически важно минимизировать время простоя.
Пример:
Основная БД выходит из строя.
Реплика автоматически становится новой основной БД (в случае настройки автоматического failover).
Время простоя составляет секунды или минуты, в отличие от восстановления из бэкапа, которое может занять часы.

2. Распределение нагрузки (Load Balancing)
Реплики могут использоваться для распределения нагрузки на чтение. Это полезно для систем с высокой нагрузкой, где основная БД занята обработкой запросов на запись, а реплики обслуживают запросы на чтение.
Пример:
Основная БД обрабатывает запросы на запись (INSERT, UPDATE, DELETE).
Реплики обрабатывают запросы на чтение (SELECT).
Это снижает нагрузку на основную БД и повышает общую производительность системы.

3. Масштабируемость
Реплики позволяют масштабировать систему горизонтально, добавляя дополнительные узлы для обработки запросов. Это особенно полезно для растущих приложений с увеличивающейся нагрузкой.
Пример:
Добавление новых реплик для обслуживания растущего числа пользователей.
Возможность географического распределения реплик для снижения задержек.

4. Тестирование и аналитика
Реплики могут использоваться для тестирования новых версий приложений, выполнения аналитических запросов или создания отчетов без воздействия на основную БД.
Пример:
Тестирование нового функционала на реплике перед развертыванием на основной БД.
Выполнение тяжелых аналитических запросов на реплике, чтобы не нагружать основную БД.

5. Быстрое восстановление данных
В случае потери данных на основной БД, реплика может быть использована для быстрого восстановления. Это особенно полезно, если данные были случайно удалены или повреждены.
Пример:
Основная БД была повреждена из-за сбоя.
Данные могут быть быстро восстановлены из реплики.

6. Географическая отказоустойчивость
Реплики могут быть размещены в разных географических регионах, что обеспечивает отказоустойчивость в случае сбоя в одном регионе.
Пример:
Основная БД находится в одном регионе, а реплика — в другом.
В случае сбоя в основном регионе, реплика в другом регионе продолжает работу.

7. Реальное время синхронизации
Реплики синхронизируются с основной БД в реальном времени (или с минимальной задержкой), что обеспечивает актуальность данных. Это важно для систем, где критически важно иметь доступ к последним данным.
Пример:
Финансовые системы, где важно иметь доступ к последним транзакциям.
Онлайн-игры, где состояние игры должно быть синхронизировано для всех игроков.

8. Упрощение процесса резервного копирования
Реплики могут использоваться для создания резервных копий без нагрузки на основную БД. Это позволяет выполнять бэкапы без влияния на производительность основной системы.
Пример:
Резервное копирование выполняется на реплике, а не на основной БД.
Основная БД продолжает работать без замедлений.

Сравнение с обычным резервным копированием

Когда использовать реплику?
● Высокая доступность: Если система должна быть доступна 24/7.
● Распределение нагрузки: Если нагрузка на чтение высока.
● Быстрое восстановление: Если критически важно минимизировать время простоя.
● Тестирование и аналитика: Если нужно выполнять тесты или аналитические запросы без воздействия на основную БД.
● Географическая отказоустойчивость: Если система должна быть устойчива к сбоям в одном регионе.

● Когда использовать обычное резервное копирование?
● Долгосрочное хранение: Если нужно хранить данные на длительный срок.
● Архивирование: Если нужно сохранить данные на определенный момент времени.
● Бюджетные ограничения: Если нет ресурсов для поддержки реплик.

Итог
Использование реплики дает преимущества в случаях, где важны:
● Высокая доступность.
● Минимальное время простоя.
● Распределение нагрузки.
● Быстрое восстановление данных.
● Географическая отказоустойчивость.
Однако репликация требует дополнительных ресурсов и настройки, поэтому выбор между репликой и обычным резервным копированием зависит от требований вашей системы.
